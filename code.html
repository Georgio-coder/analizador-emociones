<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador de Emociones Faciales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .video-container {
            position: relative;
            width: 300px; /* Tamaño fijo del contenedor */
            height: 300px;
            margin: 0 auto;
            overflow: hidden; /* Oculta cualquier desbordamiento */
            border-radius: 8px;
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Asegura que el video cubra el contenedor */
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-100 min-h-screen py-8">
    <div class="container mx-auto px-4">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">Analizador de Emociones Faciales</h1>
            <p class="text-lg text-gray-600">Permite que tu cámara analice tus expresiones faciales</p>
        </header>

        <div class="grid md:grid-cols-2 gap-8 items-start">
            <div class="space-y-6">
                <div class="video-container shadow-xl">
                    <!-- MEJORA: Añadimos dimensiones iniciales para evitar saltos de layout -->
                    <video id="video" width="300" height="300" autoplay muted playsinline class="bg-gray-200"></video>
                    <canvas id="overlay"></canvas>
                </div>
                
                <div class="text-center space-y-4">
                    <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full text-lg transition duration-300 transform hover:scale-105 shadow-lg pulse" disabled>
                        Iniciar Análisis
                    </button>
                    <button id="restartButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full text-lg transition duration-300 transform hover:scale-105 shadow-lg hidden">
                        Reiniciar Análisis
                    </button>
                </div>
                
                <div class="text-center py-4 px-6 bg-white rounded-lg shadow-md">
                    <p class="text-gray-700 font-medium mb-2">Duración del análisis:</p>
                    <div class="flex justify-center gap-4">
                        <button id="duration20" class="duration-btn bg-indigo-600 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-700 duration-200">20s</button>
                        <button id="duration30" class="duration-btn bg-indigo-400 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-500 duration-200">30s</button>
                        <button id="duration40" class="duration-btn bg-indigo-400 text-white px-4 py-2 rounded-full text-sm hover:bg-indigo-500 duration-200">40s</button>
                    </div>
                </div>

                <div id="status" class="text-center py-4 px-6 bg-white rounded-lg shadow-md">
                    <p class="text-gray-700 font-medium">Estado: <span id="statusText">Preparando la aplicación...</span></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 10%"></div>
                    </div>
                </div>
                
                <div id="timer" class="text-center text-2xl font-bold text-indigo-800 hidden">
                    <i class="fas fa-hourglass-half fa-spin"></i> <span id="timeLeft">20</span> segundos restantes
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-xl h-full">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-line text-indigo-600"></i> Evolución de Emociones
                </h2>
                <div class="relative h-80">
                    <canvas id="emotionChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="result" class="mt-8 hidden">
            <!-- El resto del HTML de resultados se mantiene igual... -->
        </div>
    </div>

    <script>
        const emotionTranslations = { happy: 'Alegría', sad: 'Tristeza', angry: 'Ira', fearful: 'Miedo', surprised: 'Sorpresa', disgusted: 'Asco', neutral: 'Neutral' };
        const emotionDescriptions = {
            happy: '¡Te has sentido mayormente alegre durante el análisis! La alegría es fundamental para una vida positiva.',
            sad: 'La tristeza ha sido tu emoción predominante. Es una emoción válida que nos ayuda a valorar los momentos felices.',
            angry: 'La ira ha sido tu principal emoción. Respirar profundamente puede ayudarte a manejar esta emoción.',
            fearful: 'El miedo ha sido lo más detectado. Recuerda que el miedo puede ser una señal para evaluar situaciones.',
            surprised: '¡La sorpresa ha destacado en tu análisis! Esta emoción revela sensibilidad a cambios inesperados.',
            disgusted: 'El asco ha sido tu emoción principal. Esta emoción nos protege de situaciones desagradables.',
            neutral: 'Tu expresión ha sido mayormente neutral. A veces la calma también es importante.'
        };
        
        let emotionChart, detectionInterval, analysisDuration = 20, timeLeft = analysisDuration, frameCount = 0;
        let emotionTotals = { happy: 0, sad: 0, angry: 0, fearful: 0, surprised: 0, disgusted: 0, neutral: 0 };
        
        const videoElement = document.getElementById('video');
        const overlayCanvas = document.getElementById('overlay');
        const startButton = document.getElementById('startButton');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const resultDiv = document.getElementById('result');
        const timerDiv = document.getElementById('timer');
        const timeLeftSpan = document.getElementById('timeLeft');
        
        function initializeChart() {
            const ctx = document.getElementById('emotionChart').getContext('2d');
            emotionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Alegría', data: [], borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.3, fill: true },
                        { label: 'Tristeza', data: [], borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.3, fill: true },
                        { label: 'Ira', data: [], borderColor: '#EF4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.3, fill: true },
                        // CORRECCIÓN: Había un error tipográfico 'rglesa' en el color de Miedo
                        { label: 'Miedo', data: [], borderColor: '#8B5CF6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.3, fill: true },
                        { label: 'Sorpresa', data: [], borderColor: '#F59E0B', backgroundColor: 'rgba(245, 158, 11, 0.1)', tension: 0.3, fill: true },
                        { label: 'Asco', data: [], borderColor: '#EC4899', backgroundColor: 'rgba(236, 72, 153, 0.1)', tension: 0.3, fill: true }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 1 }, x: {} }, animation: { duration: 0 } }
            });
        }
        
        async function loadModels() {
            statusText.textContent = 'Cargando modelos de IA...';
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
                ]);
                progressBar.style.width = '100%';
                statusText.textContent = 'Modelos cargados. Listo para iniciar.';
                startButton.disabled = false;
                console.log('Modelos cargados.');
            } catch (error) {
                console.error('Error cargando modelos:', error);
                statusText.textContent = 'Error al cargar modelos. Recarga la página.';
                progressBar.style.backgroundColor = 'red';
            }
        }
        
        // CORRECCIÓN CLAVE: Lógica de la cámara simplificada y más robusta.
        async function startCamera() {
            statusText.textContent = 'Solicitando acceso a la cámara...';
            startButton.disabled = true;
            progressBar.style.width = '0%';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } // Solicitar una resolución estándar
                });
                videoElement.srcObject = stream;
                
                // Usar 'onloadedmetadata' es más fiable que 'play' para obtener las dimensiones
                videoElement.onloadedmetadata = () => {
                    statusText.textContent = 'Cámara iniciada. Preparando análisis...';
                    
                    // Ajustar el canvas de superposición a la resolución REAL del video
                    const videoWidth = videoElement.videoWidth;
                    const videoHeight = videoElement.videoHeight;
                    
                    overlayCanvas.width = videoWidth;
                    overlayCanvas.height = videoHeight;
                    
                    startAnalysis();
                };
            } catch (error) {
                console.error('Error accediendo a la cámara:', error);
                statusText.textContent = 'Error al acceder a la cámara. Asegúrate de dar permisos.';
                startButton.disabled = false;
            }
        }
        
        function startAnalysis() {
            statusText.textContent = 'Análisis en progreso...';
            timerDiv.classList.remove('hidden');
            timeLeft = analysisDuration; // Reiniciar el contador
            updateTimer();
            
            const countdown = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) clearInterval(countdown);
            }, 1000);
            
            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                
                if (detections) {
                    const expressions = detections.expressions;
                    frameCount++;
                    for (const emotion in expressions) {
                        if (emotionTotals.hasOwnProperty(emotion)) {
                            emotionTotals[emotion] += expressions[emotion];
                        }
                    }
                    updateChart(expressions);
                }
            }, 500);
            
            setTimeout(stopAnalysis, analysisDuration * 1000);
        }
        
        function updateChart(expressions) {
            const timeLabel = (analysisDuration - timeLeft).toFixed(1);
            emotionChart.data.labels.push(timeLabel);
            
            emotionChart.data.datasets[0].data.push(expressions.happy);
            emotionChart.data.datasets[1].data.push(expressions.sad);
            emotionChart.data.datasets[2].data.push(expressions.angry);
            emotionChart.data.datasets[3].data.push(expressions.fearful);
            emotionChart.data.datasets[4].data.push(expressions.surprised);
            emotionChart.data.datasets[5].data.push(expressions.disgusted);
            
            if (emotionChart.data.labels.length > 40) { // Limitar puntos
                emotionChart.data.labels.shift();
                emotionChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            emotionChart.update();
        }
        
        function stopAnalysis() {
            clearInterval(detectionInterval);
            timerDiv.classList.add('hidden');
            
            const stream = videoElement.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            videoElement.srcObject = null; // Liberar el objeto de video
            
            statusText.textContent = 'Análisis finalizado';
            
            if (frameCount === 0) {
                statusText.textContent = 'No se detectó ningún rostro durante el análisis.';
                document.getElementById('restartButton').classList.remove('hidden');
                startButton.classList.add('hidden');
                return;
            }

            // Calcular y mostrar resultados... (el resto de tu lógica es buena y se mantiene)
            const avgEmotions = {};
            for (const emotion in emotionTotals) {
                avgEmotions[emotion] = emotionTotals[emotion] / frameCount;
            }
            
            const dominantEmotion = Object.keys(avgEmotions).reduce((a, b) => avgEmotions[a] > avgEmotions[b] ? a : b);
            
            // Re-utilizar la estructura de resultados que ya tenías
            resultDiv.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl overflow-hidden max-w-3xl mx-auto">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
                        <h2 class="text-xl font-bold text-white flex items-center justify-center gap-2">
                            <i class="fas fa-chart-pie"></i> Resultado del Análisis
                        </h2>
                    </div>
                    <div class="p-6">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-indigo-800 mb-2">
                                Emoción Predominante: ${emotionTranslations[dominantEmotion]}
                            </p>
                        </div>
                        <p class="text-gray-600 px-4 py-3 bg-gray-50 rounded-lg mt-4 border text-center">${emotionDescriptions[dominantEmotion]}</p>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            document.getElementById('restartButton').classList.remove('hidden');
            startButton.classList.add('hidden');
        }

        function updateTimer() {
            timeLeftSpan.textContent = timeLeft;
            if (timeLeft <= 5) timeLeftSpan.parentElement.classList.add('text-red-500');
        }
        
        function resetAnalysis() {
            timeLeft = analysisDuration;
            frameCount = 0;
            for(const key in emotionTotals) { emotionTotals[key] = 0; }
            
            emotionChart.data.labels = [];
            emotionChart.data.datasets.forEach(dataset => dataset.data = []);
            emotionChart.update();
            
            resultDiv.classList.add('hidden');
            startButton.disabled = false;
            startButton.classList.remove('hidden');
            document.getElementById('restartButton').classList.add('hidden');
            statusText.textContent = 'Listo para iniciar nuevo análisis';
            progressBar.style.width = '100%';
            timeLeftSpan.parentElement.classList.remove('text-red-500');
        }

        function setDuration(seconds, event) {
            analysisDuration = seconds;
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.replace('bg-indigo-600', 'bg-indigo-400');
                btn.classList.replace('hover:bg-indigo-700', 'hover:bg-indigo-500');
            });
            event.target.classList.replace('bg-indigo-400', 'bg-indigo-600');
            event.target.classList.replace('hover:bg-indigo-500', 'hover:bg-indigo-700');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('duration20').addEventListener('click', (e) => setDuration(20, e));
            document.getElementById('duration30').addEventListener('click', (e) => setDuration(30, e));
            document.getElementById('duration40').addEventListener('click', (e) => setDuration(40, e));
            document.getElementById('restartButton').addEventListener('click', resetAnalysis);
            
            initializeChart();
            loadModels();
            
            startButton.addEventListener('click', startCamera);
        });
    </script>
</body>
</html>